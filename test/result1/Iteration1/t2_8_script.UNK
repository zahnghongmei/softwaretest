/**********************************************************************************

	Project Name: SimpleAdmin CMS Theme
	Project Description: A clean admin theme
	File Name: script.js
	Author: Adi Purdila
	Author URI: http://www.adipurdila.com
	Version: 1.0.0
	
**********************************************************************************/
function getContextPath() {
    var pathName = window.location.pathname;
    var index = pathName.substr(1).indexOf("/");
    var result = pathName.substr(0,index+1);
    return result;
}

function doPost(url,data,callback,type) {
	type = type || 'json';
	$.post(url,data,callback,type);
}

$(document).ready(function() {

	var _alert = window.alert;
	MyAlert = function(str)
    {
     var shield = document.createElement("DIV");
     shield.id = "shield";
     shield.style.position = "absolute";
     shield.style.left = "0px";
     shield.style.top = "0px";
     shield.style.width = "100%";
     shield.style.height = document.body.scrollHeight+"px";
     //弹出对话框时的背景颜色
     shield.style.background = "rgb(255, 255, 255, 0)";
     shield.style.textAlign = "center";
     shield.style.zIndex = "25";
     //背景透明 IE有效
     shield.style.filter = "alpha(opacity=0)";
     var alertFram = document.createElement("DIV");
     alertFram.id="alertFram";
     alertFram.style.position = "absolute";
     alertFram.style.left = "50%";
     alertFram.style.top = "50%";
     alertFram.style.marginLeft = "-225px";
     alertFram.style.marginTop = "-75px";
     alertFram.style.width = "450px";
     alertFram.style.height = "150px";
     alertFram.style.background = "#ff0000";
     alertFram.style.textAlign = "center";
     alertFram.style.lineHeight = "150px";
     alertFram.style.zIndex = "300";
     strHtml = "<ul style=\"list-style:none;margin:0px;padding:0px;width:100%\">\n";
     strHtml += " <li style=\"background:#11D5FF;text-align:left;padding-left:20px;font-size:14px;font-weight:bold;height:25px;line-height:25px;border:1px solid #F9CADE;\">[错误提示]</li>\n";
     strHtml += " <li style=\"background:#fff;text-align:center;font-size:12px;height:120px;line-height:120px;border-left:1px solid #F9CADE;border-right:1px solid #F9CADE;\">"+str+"</li>\n";
     strHtml += " <li style=\"background:#FDEEF4;text-align:center;font-weight:bold;height:25px;line-height:25px; border:1px solid #F9CADE;\"><input type=\"button\" value=\"确 定\" onclick=\"doOk()\" /></li>\n";
     strHtml += "</ul>\n";
     alertFram.innerHTML = strHtml;
     document.body.appendChild(alertFram);
     document.body.appendChild(shield);
     //var ad = setInterval("doAlpha()",5);
     this.doOk = function(){
         alertFram.style.display = "none";
         shield.style.display = "none";
         //hiddenModel();
     }
     alertFram.focus();
     document.body.onselectstart = function(){return false;};
    };
	
	MyAlert.noConflict = function() { 
		  window.alert = _alert; 
	}; 
 
// expose API 
window.alert = window.MyAlert = MyAlert; 
	//Content boxes expand/collapse
	$(".initial-expand").hide();

	$("div.content-module-heading").click(function(){
		$(this).next("div.content-module-main").slideToggle();

		$(this).children(".expand-collapse-text").toggle();
	});
	
	
	
	$(".login-model,.login-tip").hide();
	
	$(".login-btn").click(function(){
		
		var samlRequest = $("input[name='SAMLRequest']").val();
		var relayState = $("input[name='RelayState']").val();
		$.post(getContextPath() + '/login?act=2fa',$('#login-form').serialize(),function(data){
			if (data.errorCode=='1000'){
				showModel();
				$(".login-model").show();
				$('#qrcode img').attr('src',data.imageData).attr('title',data.tokenSN);				
				var interval =  setInterval(checkStatus,3000);
				 
				// $('#userId').attr("disabled", true);
				// $('#password').attr("disabled", true);
				//$('.login-btn').attr("disabled", true);
			} else if (data.errorCode=='1001'){
				$(".login-tip").show();
				setTimeout(function(){$(".login-tip").hide();},3000);//3秒后执行该方法
				//alert('您还没有令牌，请先下载App和令牌再试。');
			} else if (data.errorCode=='1003'){
				alert('用户名或密码错误。');
			} else if (data.errorCode=='1005'){
				alert('用户状态不可用。');
			} else {
				alert('服务器错误，请联系管理员。')
			}
		},'json');
		
		return false;
	});
	
	
	$(".model-btn").click(function(){
		var pass = $('#dynamic-input').val();
		var samlRequest = $("input[name='SAMLRequest']").val();
		var relayState = $("input[name='RelayState']").val();
		if(pass == ""){
			$('.model-error').html('请输入验证码');
		}else{
		$.post(getContextPath() + '/login?act=otp',{password:pass,SAMLRequest:samlRequest,RelayState:relayState},function(data){
			$('.model-error').html('');
			if (data.errorCode=='1000'){
				//alert('登录成功。');
				//alert(samlRequest !== null);
				//alert(samlRequest !== undefined);
				//alert(samlRequest !== '');
				//window.location.href = getContextPath() + '/samlsso';
				if (samlRequest !== null && samlRequest !== undefined && samlRequest !== '') {
					sppost(getContextPath() +'/samlsso', {SAMLRequest:samlRequest,RelayState:relayState});	
		
					}else{	
						//用一个页面接收,可以支持多个链接,链接到多个sp
						//window.location.href = getContextPath() + '/home.jsp';
						//直接跳到OA系统
						window.location.href = getContextPath() + '/samlsso?SPId=oa&RelayState=/sso_4A_skip.jsp';
					}
				
			} else if (data.errorCode=='1002'){
				$('.model-error').html('请先使用静态密码登录。');
			} else if (data.errorCode=='1003'){
				//原来是:动态验证码错误.
				$('.model-error').html('提示：验证码错误,请重新输入');
			} else if (data.errorCode=='1004'){
				$('.model-error').html('认证失败。');
			} else if (data.errorCode=='1005'){
				$('.model-error').html('用户状态不可用。');
			} else if (data.errorCode=='1006'){
				$('.model-error').html('令牌已锁，请联系管理员。');
			} else {
				$('.model-error').html('服务器错误，请联系管理员。')
			}
		},'json');
		}
		return false;
	});
	
	function checkStatus() {
		var samlRequest = $("input[name='SAMLRequest']").val();
		var relayState = $("input[name='RelayState']").val();
		$.post(getContextPath() + '/login?act=checkLogin',function(data){

			if (data.errorCode=='1000'){
				//alert('登录成功。');
				//alert(samlRequest !== null);
				//alert(samlRequest !== undefined);
				//alert(samlRequest !== '');
/*				
 * 注意：如果这里用alert打断进行调试，时间超过3s，由于不能把SPId传过去，会发生异常
				Exception when reading authentication request or initiating request
				（Neither SAML request nor issuer is specified）
				异常次数可能约是等待时间/3s的倍数
*/
				//alert(getContextPath() + '/samlsso');
				if (samlRequest !== null && samlRequest !== undefined && samlRequest !== '') {
					sppost(getContextPath() +'/samlsso', {SAMLRequest:samlRequest,RelayState:relayState});	
		
					}else{	
						//用一个页面接收,可以支持多个链接,链接到多个sp
						//window.location.href = getContextPath() + '/home.jsp';
						//直接跳到OA系统
						//window.location.href = getContextPath() + '/samlsso?SPId=sp2&RelayState=/spservice.jsp';
						window.location.href = getContextPath() + '/samlsso?SPId=oa&RelayState=/sso_4A_skip.jsp';
					}
				//window.location.href = getContextPath() + '/home.jsp';
			} 
		},'json');
	}
});

//sp turn method
function sppost(url, params) {
    var temp = document.createElement("form");
    temp.action = url;
   // _blank是最常见的链接方式，表示超链接的目标地址在新建窗口中打开； 
    //_self表示“相同窗口”。点击链接后，地址栏不变； 
    //_top表示整页窗口； 
    //_parent表示父窗口。 
    temp.target = "_self";
    temp.method = "post";
    temp.style.display = "none";
    for (var x in params) {
        var opt = document.createElement("input");
        opt.name = x;
        opt.value = params[x];
        temp.appendChild(opt);
    }
    document.body.appendChild(temp);
    temp.submit();
    return temp;
}
